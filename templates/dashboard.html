<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spotify Stats Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Roboto', sans-serif; background-color: #121212; color: #fff; margin:0; padding:0; }
    header { background-color:#1DB954; padding:20px; display:flex; align-items:center; flex-wrap:wrap; }
    header img { border-radius:50%; width:60px; margin-right:15px; }
    header h1 { font-size:24px; margin:0; }
    .container { padding:20px; max-width:1200px; margin:auto; }
    .section { margin-bottom:50px; }
    h2 { color:#1DB954; margin-bottom:20px; }

    #track { display:flex; align-items:center; gap:20px; background-color:#1e1e1e; padding:20px; border-radius:15px; flex-wrap:wrap; }
    #track img { width:150px; border-radius:12px; }
    #track div { flex:1; min-width:200px; }
    .progress-container { background:#333; border-radius:10px; height:10px; width:100%; margin-top:10px; }
    .progress-bar { height:10px; background:#1DB954; width:0%; border-radius:10px; }

    .cards { display:flex; flex-wrap:wrap; gap:20px; }
    .card { background-color:#1e1e1e; border-radius:12px; padding:15px; flex:1 1 200px; text-align:center; transition: transform 0.2s; }
    .card:hover { transform:scale(1.05); box-shadow:0 0 15px rgba(29,185,84,0.5); }
    .card img { width:100px; border-radius:8px; margin-bottom:10px; }

    .top-tracks { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; }
    .track-card { background-color:#1e1e1e; border-radius:12px; padding:10px; width:200px; text-align:center; transition: transform 0.2s; }
    .track-card:hover { transform:scale(1.05); box-shadow:0 0 10px rgba(29,185,84,0.5); }
    .track-card img { width:150px; border-radius:8px; margin-bottom:10px; }

    @media (max-width:1024px){ header h1{font-size:20px;} #track img{width:120px;} .track-card{width:180px;} }
    @media (max-width:768px){ header{justify-content:center;text-align:center;} header img{margin-bottom:10px;} #track{flex-direction:column;align-items:center;} #track img{width:100%; max-width:200px;} .cards,.top-tracks{flex-direction:column;align-items:center;} .card,.track-card{width:80%; max-width:300px;} }
    @media (max-width:480px){ header h1{font-size:18px;} #track img{max-width:180px;} .track-card img{width:120px;} }
</style>
</head>
<body>

<header>
    {% if user_profile and user_profile.profile_image %}
        <img src="{{ user_profile.profile_image }}" alt="Profile Picture">
    {% endif %}
    <h1>{{ user_profile.display_name if user_profile else "Spotify User" }}'s Dashboard</h1>
</header>

<div class="container">
    <div class="section">
        <h2>Currently Playing</h2>
        <div id="track">
            <img src="" id="track-img" alt="Album Art">
            <div>
                <h3 id="track-name">Loading...</h3>
                <p id="track-artists"></p>
                <p>Seconds Played: <span id="seconds">0</span></p>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Total Minutes Listened</h2>
        <div class="cards">
            <div class="card">
                <h1>{{ total_minutes }}</h1>
                <p>minutes</p>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Top Artists</h2>
        <div class="cards">
            {% for artist, count in top_artists %}
            <div class="card">
                <h3>{{ artist }}</h3>
                <p>{{ count }} plays</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="section">
        <h2>Top 50 Tracks</h2>
        <div class="top-tracks">
            {% for track in top_tracks %}
            <div class="track-card">
                <img src="{{ track.album_image }}" alt="Album Art">
                <h4>{{ track.track_name }}</h4>
                <p>{{ track.artists }}</p>
                <p>{{ track.count }} plays</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
let seconds = 0;
let trackDuration = 180;

async function fetchCurrentTrack() {
    const res = await fetch('/current-track');
    const data = await res.json();

    const trackImg = document.getElementById('track-img');
    const trackName = document.getElementById('track-name');
    const trackArtists = document.getElementById('track-artists');
    const secondsEl = document.getElementById('seconds');
    const progressBar = document.getElementById('progress-bar');

    if(data.error){
        trackName.innerText = data.error;
        trackArtists.innerText = "";
        trackImg.src = "";
        return;
    }

    if(data.message){
        trackName.innerText = data.message;
        trackArtists.innerText = "";
        trackImg.src = "";
        seconds = 0;
        secondsEl.innerText = seconds;
        progressBar.style.width = "0%";
        return;
    }

    trackImg.src = data.album_image || "";
    trackName.innerText = data.track_name || "Unknown Track";
    trackArtists.innerText = data.artists || "Unknown Artist";
    seconds = data.seconds_played || 0;
    secondsEl.innerText = seconds;

    trackDuration = data.duration || 180;
    const percent = Math.min((seconds / trackDuration) * 100, 100);
    progressBar.style.width = percent + "%";
}

function updateSeconds(){
    const secondsEl = document.getElementById('seconds');
    const progressBar = document.getElementById('progress-bar');
    if(secondsEl && seconds > 0){
        seconds++;
        secondsEl.innerText = seconds;
        const percent = Math.min((seconds / trackDuration) * 100, 100);
        progressBar.style.width = percent + "%";
    }
}

fetchCurrentTrack();
setInterval(fetchCurrentTrack, 5000);
setInterval(updateSeconds, 1000);
</script>

</body>
</html>
